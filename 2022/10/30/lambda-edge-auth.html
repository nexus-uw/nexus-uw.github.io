<!DOCTYPE html>
<html>

  
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>0.1.0 edge-lambda-url-authorizer is now ready for use</title>
  <meta name="description" content="Today I am happy to announce the release of edge-lambda-url-authorizer 0.1.0 (ready for actual use)">
  <meta name="image" content="/favicon-32x32.png">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://ramsay.xyz/2022/10/30/lambda-edge-auth.html">
  <link rel="alternate" type="application/rss+xml" title="Simon Ramsay" href="/feed.xml">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#b91d47">
  <meta name="theme-color" content="#b91d47">
  <meta http-equiv="onion-location" content="http://ramsayswljlwqo7yvw3ovxhyzavllyduxkgh4rbobzkc263jyro6cjyd.onion/2022/10/30/lambda-edge-auth.html" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src 'self'; style-src 'self'; manifest-src 'self';">
  <meta name="google" content="notranslate"/>

</head>


  <body>

    
<header class="">

  <div class="header-links">

    <a class="" href="/">Simon Ramsay</a>

    <div class="about-link">
      |
      <a class="" href="/about">about</a>
    </div>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="post-header">
    <h1 class="post-title" itemprop="name headline">0.1.0 edge-lambda-url-authorizer is now ready for use</h1>
    <p class="post-meta"><time datetime="2022-10-30T00:00:00-05:00" itemprop="datePublished">Oct 30, 2022</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Simon</span></span></p>
  </div>

  <div class="post-content" itemprop="articleBody">
    <p>Today I am happy to announce the release of <a href="https://www.npmjs.com/package/edge-lambda-url-authorizer">edge-lambda-url-authorizer 0.1.0</a> (ready for actual use)</p>

<h1 id="what">What</h1>
<p>edge-lambda-url-authorizer is a NodeJS package (with Typescript types) to be deployed a Lambda@Edge handler for Cloudfront origin requests. This package will <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html">sigv4 sign</a> the incoming request with the lambda’s instance credentials using <a href="https://www.npmjs.com/package/aws4">aws4</a> before forwarding the request to the origin. The origin is expected to be a <a href="https://aws.amazon.com/blogs/aws/announcing-aws-lambda-function-urls-built-in-https-endpoints-for-single-function-microservices/">Lambda Function URL</a> endpoint with IAM_AUTH enabled.</p>

<p><img src="/assets/edge_signer.drawio.png" alt="" /></p>

<h1 id="why-lambda-url---removed-extra-unnecessary-dependency-on-apigateway">Why lambda url -&gt; removed extra (unnecessary) dependency on ApiGateway.</h1>
<h3 id="unnecessary">unnecessary</h3>
<p>api gateway has a whole list of features and benefits for using, but for a basic ‘please expose my lambda as a public endpoint’ it is unnecessary</p>

<p>apigateway is a separate service from lambda (so your chance of something killing your service is higher) us-west-2 had a large apigateway outage earlier this month</p>

<h3 id="save-a-few-pennies">save a few pennies</h3>
<blockquote>
  <p>Function URL Pricing
Function URLs are included in Lambda’s request and duration pricing. For example, let’s imagine that you deploy a single Lambda function with 128 MB of memory and an average invocation time of 50 ms. The function receives five million requests every month, so the cost will be $1.00 for the requests, and $0.53 for the duration. The grand total is $1.53 per month, in the US East (N. Virginia) Region.</p>
</blockquote>

<p>function url does not cost extra</p>

<p>api gateway costs $ per million requests (after the free tier) https://aws.amazon.com/api-gateway/pricing/
-&gt; this tends to be a larger expense than the underlying lambda</p>

<p>(for ammobin.ca, this line item represented almost 10% of the monthly AWS spend)</p>

<h1 id="challenges-with-plain-function-url">challenges with plain function url</h1>
<h2 id="cors">CORS</h2>
<p>browsers will make CORS requests (which are supported) b/c the function url is on a different domain from one’s website. This creates an extra round trip for each actual request. (question: do OPTIONS requests add to your aws bill?)</p>

<h2 id="csp">CSP</h2>
<p>need to add lambda url to an Content-Security-Policy</p>
<ul>
  <li>different for each stage/region -&gt; more work to generate/maintain</li>
  <li>one more thing to worry about</li>
  <li>multiple function urls require multiple domains to add to the policy</li>
</ul>

<h2 id="randomauto-generated-domain">random/auto generated domain</h2>
<p>migrating function urls now requires server updates (instead of pointing to custom domain)</p>

<p>ppl might ask why requests are going off to some random auto generated domain?</p>

<p>if the lambda function were to be deleted + recreated (intentionally or not), unable to get old url back -&gt; risk someone might snag it or have to update a bunch of references to it
(could be very hard if hard coded in client sdks or the like)</p>

<h2 id="lacks-security-features-auto-scan-tools-can-complain">lacks security features (auto scan tools can complain)</h2>
<p>aws to their credit, launched with excellent iam policy support for (make sure that account is ‘secure’)
see https://docs.aws.amazon.com/lambda/latest/dg/urls-auth.html#urls-governance</p>

<p>auto scan tools can flag ‘endpoint without authentication enabled’, enable IAM_AUTH keeps the bots off your back</p>

<h2 id="bot-protection">bot protection</h2>
<p>cant apply aws waf (but can use lambda throttling)</p>

<h2 id="caching">caching</h2>
<p>req could/should be cached. could be cached by browser, but not by cdn</p>

<p>if one site receives enough traffic, all of these extraneous lambda invocations can start to add up</p>

<h1 id="solution-enable-iam_auth--cloudfront">solution enable IAM_AUTH + cloudfront</h1>
<p>have lambda@edge sign incoming origin request</p>

<h2 id="cloudfront-features">cloudfront features</h2>
<ul>
  <li>custom domain</li>
  <li>caching policy</li>
  <li>AWS Shield + WAF protection</li>
  <li>edge routing (could also do something like https://ramsay.xyz/2022/01/05/release-of-blue-green-static-aws-edge.html to internal route to the closest aws region for backing lambda execution)</li>
</ul>

<h2 id="iam-auth">iam auth</h2>
<p>apply an iam resource policy (handy for cross account access)</p>

<p>prevents people from calling your api directly (to by pass your cloudfront config)</p>

<p>no more ‘api without authentication’ security scan issues</p>

<h3 id="alt">alt</h3>
<p>custom header auth -&gt; brittle, not great, does not let people get creative (but current suggested solution on https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistS3AndCustomOrigins.html#concept_lambda_function_url)</p>

<p>sigv4 lambda is ~2ms execution time for p90 so it doesn’t cost too much (and execute on origin req, so cache reqs need no exe)</p>

<h3 id="issue">issue</h3>
<p>origins per distribution defaults to 25 (can be increased to ???)
https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-web-distributions</p>

<h3 id="next-steps">next steps</h3>
<p>could be generalized further into a generic sigv4 proxy for aws resources (ie: call dynamoDb or s3 directly). but that is much more complicated (and risky). it would require a very good understanding of IAM policies to properly secure one’s resources.</p>

<p><img src="/assets/3.jpg" alt="" /></p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <h2 class="footer-heading">Simon Ramsay
      <a href="http://ramsayswljlwqo7yvw3ovxhyzavllyduxkgh4rbobzkc263jyro6cjyd.onion">(TOR)</a>
      <a href="http://ramsay.i2p/">(I2P)</a></h2>
      <div class="footer-col-wrapper">
        <div class="footer-col footer-col-6">
          <ul class="contact-list">
            <li>
              <a href="mailto:simon@ramsay.xyz">simon@ramsay.xyz</a>
            </li>
            <li>
              <a href="https://keybase.io/nexusuw/key.asc">F50F7E3612EA2B78</a>
            </li>
          </ul>
        </div>
        <div class="footer-col footer-col-6">
          <ul class="social-media-list">
            <li><a href="https://github.com/nexus-uw"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">nexus-uw</span></a>
</li>
            <li><a href="https://keybase.io/nexusuw"><span class="username">Keybase: nexusuw</span></a> <a href="http://keybase5wmilwokqirssclfnsqrjdsi7jdir5wy7y7iu3tanwmtp6oid.onion/nexusuw">(TOR)</a>
</li>
          </ul>
        </div>
        <div class="footer-col footer-col-12">
          2013 - CURRENT YEAR <a href="http://unlicense.org">Unlicensed</a>
        </div>
      </div>
  </div>
</footer>

    <p class="china_number_1">动态网自由门 天安門 天安门 法輪功 李洪志 Free Tibet 六四天安門事件 The Tiananmen Square protests of 1989 天安門大屠殺 The Tiananmen Square Massacre
    反右派鬥爭 The Anti-Rightist Struggle 大躍進政策 The Great Leap Forward 文化大革命 The Great Proletarian Cultural Revolution 人權 Human
    Rights 民運 Democratization 自由 Freedom 獨立 Independence 多黨制 Multi-party system 台灣 臺灣 Taiwan Formosa 中華民國 Republic of China
    西藏 土伯特 唐古特 Tibet 達賴喇嘛 Dalai Lama 法輪功 Falun Dafa 新疆維吾爾自治區 The Xinjiang Uyghur Autonomous Region 諾貝爾和平獎 Nobel Peace Prize
    劉暁波 Liu Xiaobo 民主 言論 思想 反共 反革命 抗議 運動 騷亂 暴亂 騷擾 擾亂 抗暴 平反 維權 示威游行 李洪志 法輪大法 大法弟子 強制斷種 強制堕胎 民族淨化 人體實驗 肅清 胡耀邦 趙紫陽 魏京生 王丹 還政於民
    和平演變 激流中國 北京之春 大紀元時報 九評論共産黨 獨裁 專制 壓制 統一 監視 鎮壓 迫害 侵略 掠奪 破壞 拷問 屠殺 活摘器官 誘拐 買賣人口 遊進 走私 毒品 賣淫 春畫 賭博 六合彩 天安門 天安门 法輪功 李洪志
    Winnie the Pooh 劉曉波动态网自由门
    
    #Literally #china #copypasta</p>
  </body>

</html>
